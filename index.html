<script>
let map;
let marker;

function searchPin() {
  let pin = document.getElementById("pin").value;
  let result = document.getElementById("result");

  if (!/^\d{6}$/.test(pin)) {
    result.innerHTML = "<div class='result-card'>‚ùå Enter valid 6-digit PIN</div>";
    return;
  }

  fetch("https://api.postalpincode.in/pincode/" + pin)
    .then(res => res.json())
    .then(data => {
      if (data[0].Status !== "Success") {
        result.innerHTML = "<div class='result-card'>‚ùå No data found</div>";
        return;
      }

      result.innerHTML = "";
      data[0].PostOffice.forEach(p => {
        result.innerHTML += `
          <div class="result-card">
            <b>Village / PO:</b> ${p.Name}<br>
            <b>District:</b> ${p.District}<br>
            <b>State:</b> ${p.State}<br>
            <b>PIN:</b> ${p.Pincode}
          </div>
        `;
      });

      // üîπ Get location using OpenStreetMap search
      let location =
        data[0].PostOffice[0].District + ", " +
        data[0].PostOffice[0].State + ", India";

      fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(location))
        .then(res => res.json())
        .then(loc => {
          if (loc.length > 0) {
            showMap(loc[0].lat, loc[0].lon, location);
          }
        });
    });
}

function showMap(lat, lon, text) {
  if (!map) {
    map = L.map('map').setView([lat, lon], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);
  } else {
    map.setView([lat, lon], 12);
  }

  if (marker) {
    marker.remove();
  }

  marker = L.marker([lat, lon]).addTo(map)
    .bindPopup(text)
    .openPopup();
}
</script>
